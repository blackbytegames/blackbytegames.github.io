<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Animecs Documentation</title>
    <style>
        /* Your existing styles remain the same */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; }
        .unity-header { background: #fff; border-bottom: 1px solid #ddd; padding: 12px 24px; display: flex; align-items: center; gap: 32px; }
        .unity-logo img { height: 28px; }
        .unity-nav { display: flex; gap: 4px; }
        .nav-tab { padding: 8px 16px; color: #666; text-decoration: none; border-radius: 3px; transition: all 0.2s; }
        .nav-tab:hover { background: #f0f0f0; }
        .nav-tab.active { background: #4a9eff; color: white; }
        .unity-search { margin-left: auto; }
        .unity-search input { padding: 6px 12px; border: 1px solid #ddd; border-radius: 3px; width: 280px; }
        .unity-breadcrumb { background: #f6f6f6; padding: 10px 24px; font-size: 13px; color: #666; border-bottom: 1px solid #e0e0e0; }
        .unity-breadcrumb a { color: #4a9eff; text-decoration: none; }
        .unity-layout { display: flex; height: calc(100vh - 110px); }
        .unity-sidebar-left { width: 280px; background: #f9f9f9; border-right: 1px solid #e0e0e0; overflow-y: auto; }
        .sidebar-filter { padding: 16px; border-bottom: 1px solid #e0e0e0; }
        .sidebar-filter input { width: 100%; padding: 6px 10px; border: 1px solid #ddd; border-radius: 3px; font-size: 12px; }
        .sidebar-nav { padding: 12px 0; }
        .sidebar-nav ul { list-style: none; }
        .sidebar-nav > ul > li { margin: 0; }
        .sidebar-nav a { display: block; padding: 8px 24px; color: #333; text-decoration: none; font-size: 13px; }
        .sidebar-nav a:hover { background: #e8e8e8; }
        .sidebar-nav a.active { background: #4a9eff; color: white; }
        .nav-parent-toggle { float: right; font-size: 10px; transition: transform 0.2s; }
        .nav-parent-toggle.collapsed { transform: rotate(-90deg); }
        .sidebar-nav ul ul { display: block; }
        .sidebar-nav ul ul.collapsed { display: none; }
        .unity-content { flex: 1; padding: 32px 48px; overflow-y: auto; background: white; }
        .unity-content img { max-width: 100%; height: auto; margin: 20px 0; display: block; }
        .unity-content h1 { font-size: 32px; font-weight: 600; margin: 0 0 24px 0; color: #222; }
        .unity-content h2 { font-size: 24px; font-weight: 600; margin: 48px 0 20px 0; color: #222; padding-top: 8px; border-top: 1px solid #e0e0e0; }
        .unity-content h3 { font-size: 20px; font-weight: 500; margin: 32px 0 16px 0; color: #222; }
        .unity-content p { margin: 14px 0; line-height: 1.75; color: #333; }
        .unity-content a { color: #0066cc; text-decoration: none; }
        .unity-content a:hover { text-decoration: underline; }
        .unity-content ul, .unity-content ol { margin: 16px 0; padding-left: 28px; }
        .unity-content li { margin: 6px 0; line-height: 1.7; }
        .unity-content code { background: #f0f0f0; padding: 2px 5px; border-radius: 3px; font-size: 13px; }
        .unity-content pre { background: #f6f8fa; border: 1px solid #e1e4e8; border-radius: 3px; padding: 16px; margin: 20px 0; overflow-x: auto; }
        .unity-content pre code { background: transparent; padding: 0; color: #333; }
        .unity-content table { width: 100%; border-collapse: collapse; margin: 24px 0; font-size: 13px; }
        .unity-content table th { background: #fafafa; border: 1px solid #e0e0e0; padding: 10px 14px; text-align: left; font-weight: 600; }
        .unity-content table td { border: 1px solid #e0e0e0; padding: 10px 14px; }
        .unity-sidebar-right { width: 240px; background: #fafafa; border-left: 1px solid #e0e0e0; padding: 20px; overflow-y: auto; }
        .sidebar-right-title { font-size: 11px; font-weight: 600; color: #999; margin-bottom: 16px; letter-spacing: 0.5px; }
        .sidebar-toc { list-style: none; }
        .sidebar-toc a { color: #666; text-decoration: none; font-size: 12px; line-height: 1.6; display: block; padding: 4px 0; }
        .sidebar-toc a:hover { color: #4a9eff; }
        .sidebar-toc ul { margin-left: 12px; margin-top: 4px; }
    </style>
</head>
<body>

<div class="unity-header">
    <a href="#" class="unity-logo">
        <img src="assets/logo.png" alt="Blackbyte">
    </a>
    <nav class="unity-nav">
        <a href="#" data-section="manual" class="nav-tab active">Manual</a>
        <a href="#" data-section="api" class="nav-tab">Scripting API</a>
        <a href="#" data-section="changelog" class="nav-tab">Changelog</a>
    </nav>
    <div class="unity-search">
        <input type="search" placeholder="Search" id="searchInput">
    </div>
</div>

<div class="unity-breadcrumb">
    <a href="#" id="breadcrumbSection">Manual</a>
    <span>/</span>
    <span id="breadcrumbCurrent">Animecs</span>
</div>

<div class="unity-layout">
    <div class="unity-sidebar-left">
        <div class="sidebar-filter">
            <input type="text" placeholder="Enter here to filter..." id="filterInput">
        </div>
        <nav class="sidebar-nav" id="leftNav"></nav>
    </div>

    <div class="unity-content" id="mainContent"></div>

    <div class="unity-sidebar-right">
        <div class="sidebar-right-title">IN THIS ARTICLE</div>
        <ul class="sidebar-toc" id="tocList"></ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
    let currentSection = 'manual';

    const navigation = {
        manual: [
            { title: 'About Animecs', url: 'manual/about.md' },
            { title: 'Getting Started', url: 'manual/getting-started.md' },
            { title: 'Architecture', url: 'manual/architecture.md' },
            {
                title: 'Tutorials',
                submenu: [
                    { title: 'Basic Setup', url: 'manual/tutorials/basic-setup.md' },
                    { title: 'State Machines', url: 'manual/tutorials/state-machines.md' },
                    { title: 'Blend Trees', url: 'manual/tutorials/blend-trees.md' },
                    { title: 'LOD System', url: 'manual/tutorials/lod-system.md' },
                    { title: 'Blend Shapes', url: 'manual/tutorials/blend-shapes.md' }
                ]
            },
            { title: 'Samples', url: 'manual/samples.md' },
            { title: 'Limitations', url: 'manual/limitations.md' }
        ],
        api: [
            { title: 'API Overview', url: 'api/README.md' },
            { title: 'AnimecsController', url: 'api/controller.md' },
            { title: 'Components', url: 'api/components.md' },
            { title: 'Systems', url: 'api/systems.md' },
            { title: 'Data Structures', url: 'api/data-structures.md' },
            { title: 'Bakers', url: 'api/baker.md' }
        ]
    };

    function buildNavigation(section = 'manual') {
        const nav = document.getElementById('leftNav');
        const items = navigation[section];
        let html = '<ul>';

        items.forEach((item, index) => {
            if (item.submenu) {
                html += `
                    <li class="nav-parent">
                        <a href="#" onclick="toggleSubmenu(${index}); return false;">
                            <span>${item.title}</span>
                            <span class="nav-parent-toggle" id="toggle-${index}">â–¼</span>
                        </a>
                        <ul id="submenu-${index}">`;
                item.submenu.forEach(sub => {
                    html += `<li><a href="#${sub.url}">${sub.title}</a></li>`;
                });
                html += `</ul></li>`;
            } else {
                html += `<li><a href="#${item.url}">${item.title}</a></li>`;
            }
        });

        html += '</ul>';
        nav.innerHTML = html;
    }

    function toggleSubmenu(index) {
        const submenu = document.getElementById(`submenu-${index}`);
        const toggle = document.getElementById(`toggle-${index}`);

        if (submenu.classList.contains('collapsed')) {
            submenu.classList.remove('collapsed');
            toggle.classList.remove('collapsed');
        } else {
            submenu.classList.add('collapsed');
            toggle.classList.add('collapsed');
        }
    }

    /**
     * Resolves relative paths in markdown content to absolute paths.
     */
    function resolveImagePaths(html, currentFilePath) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const images = doc.querySelectorAll('img');

        images.forEach(img => {
            let src = img.getAttribute('src');

            if (!src || src.startsWith('http') || src.startsWith('data:')) {
                return;
            }

            // Get directory of current markdown file
            const currentDir = currentFilePath.substring(0, currentFilePath.lastIndexOf('/') + 1);

            // Resolve relative path
            const resolvedPath = resolvePath(currentDir, src);
            img.setAttribute('src', resolvedPath);
        });

        return doc.body.innerHTML;
    }

    /**
     * Resolves path segments handling ../ and ./
     */
    function resolvePath(basePath, relativePath) {
        const parts = basePath.split('/').filter(p => p);
        const relParts = relativePath.split('/');

        for (const part of relParts) {
            if (part === '..') {
                parts.pop();
            } else if (part !== '.' && part !== '') {
                parts.push(part);
            }
        }

        return parts.join('/');
    }

    async function loadContent(file = 'manual/about.md') {
        try {
            const response = await fetch(file);
            const text = await response.text();
            let html = marked.parse(text);

            // Resolve image paths before inserting HTML
            html = resolveImagePaths(html, file);

            document.getElementById('mainContent').innerHTML = html;

            const parts = file.split('/');
            const fileName = parts[parts.length - 1].replace('.md', '').replace(/-/g, ' ');
            const title = fileName.charAt(0).toUpperCase() + fileName.slice(1);
            document.getElementById('breadcrumbCurrent').textContent = title;

            generateTOC();
            highlightActiveNav(file);
            document.querySelector('.unity-content').scrollTop = 0;

            setTimeout(setupMarkdownLinks, 0);
        } catch (error) {
            document.getElementById('mainContent').innerHTML =
                `<h1>Error</h1><p>Could not load ${file}. Make sure the file exists.</p>`;
        }
    }

    function setupMarkdownLinks() {
        const content = document.getElementById('mainContent');

        content.querySelectorAll('a').forEach(link => {
            let href = link.getAttribute('href');

            if (!href || href.startsWith('http') || href.startsWith('mailto:')) {
                return;
            }

            if (href.startsWith('#')) {
                href = href.substring(1);
            }

            if (href.endsWith('.md')) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();

                    let currentPath = window.location.hash.substring(1) || 'manual/about.md';
                    let currentDir = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);

                    let parts = currentDir.split('/').filter(p => p);
                    let hrefParts = href.split('/');

                    for (let part of hrefParts) {
                        if (part === '..') {
                            parts.pop();
                        } else if (part !== '.' && part !== '') {
                            parts.push(part);
                        }
                    }

                    let finalPath = parts.join('/');

                    window.location.hash = finalPath;
                    loadContent(finalPath);
                });
            }
        });
    }

    function generateTOC() {
        const content = document.getElementById('mainContent');
        const headings = content.querySelectorAll('h2, h3');
        const tocList = document.getElementById('tocList');

        if (headings.length === 0) {
            tocList.innerHTML = '<li style="color: #999; font-size: 12px;">No headings found</li>';
            return;
        }

        let html = '';
        let currentH2 = null;

        headings.forEach(heading => {
            const id = heading.textContent.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            heading.id = id;

            if (heading.tagName === 'H2') {
                if (currentH2) {
                    html += '</ul></li>';
                }
                html += `<li><a href="#${id}">${heading.textContent}</a><ul>`;
                currentH2 = true;
            } else if (heading.tagName === 'H3') {
                html += `<li><a href="#${id}">${heading.textContent}</a></li>`;
            }
        });

        if (currentH2) {
            html += '</ul></li>';
        }

        tocList.innerHTML = html;

        tocList.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const target = document.getElementById(link.getAttribute('href').substring(1));
                if (target) {
                    document.querySelector('.unity-content').scrollTo({
                        top: target.offsetTop - 20,
                        behavior: 'smooth'
                    });
                }
            });
        });
    }

    function highlightActiveNav(currentFile) {
        document.querySelectorAll('.sidebar-nav a').forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${currentFile}`) {
                link.classList.add('active');
            }
        });
    }

    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            e.preventDefault();
            const section = tab.dataset.section;

            if (section === 'changelog') {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('breadcrumbSection').textContent = 'Resources';
                document.getElementById('breadcrumbCurrent').textContent = 'Changelog';
                document.getElementById('leftNav').innerHTML = '';
                window.location.hash = 'changelog.md';
                loadContent('changelog.md');
                return;
            }

            if (!section) return;

            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            document.getElementById('breadcrumbSection').textContent =
                section === 'manual' ? 'Manual' : 'Scripting API';

            currentSection = section;
            buildNavigation(section);

            const firstItem = navigation[section][0];
            window.location.hash = firstItem.url;
            loadContent(firstItem.url);
        });
    });

    window.addEventListener('hashchange', () => {
        const hash = window.location.hash.substring(1);
        if (hash && hash !== '') {
            loadContent(hash);
        }
    });

    document.getElementById('filterInput').addEventListener('input', (e) => {
        const filter = e.target.value.toLowerCase();
        document.querySelectorAll('.sidebar-nav li').forEach(item => {
            const link = item.querySelector('a');
            if (link) {
                const text = link.textContent.toLowerCase();
                const parent = item.closest('ul');

                if (text.includes(filter)) {
                    item.style.display = 'block';
                    if (parent && parent.id && parent.id.startsWith('submenu-')) {
                        parent.classList.remove('collapsed');
                        const toggleId = parent.id.replace('submenu-', 'toggle-');
                        const toggle = document.getElementById(toggleId);
                        if (toggle) toggle.classList.remove('collapsed');
                    }
                } else {
                    item.style.display = 'none';
                }
            }
        });
    });

    buildNavigation('manual');
    const initialFile = window.location.hash.substring(1) || 'manual/about.md';
    loadContent(initialFile);
</script>
</body>
</html>